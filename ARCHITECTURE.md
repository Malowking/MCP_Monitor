# 架构设计文档

## 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户/客户端                          │
└───────────────────────┬─────────────────────────────────────┘
                        │ HTTP/REST API
                        ↓
┌─────────────────────────────────────────────────────────────┐
│                      FastAPI应用层                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │              API路由 (api/routes.py)                  │  │
│  └──────────────────────────────────────────────────────┘  │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ↓
┌─────────────────────────────────────────────────────────────┐
│               主流程编排器 (orchestrator.py)                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  1. 工具路由 → 2. 模型生成 → 3. RAG检索             │   │
│  │  4. 规则检查 → 5. 风险评估 → 6. 动态Prompt注入      │   │
│  └─────────────────────────────────────────────────────┘   │
└────┬────────┬─────────┬──────────┬──────────┬──────────────┘
     │        │         │          │          │
     ↓        ↓         ↓          ↓          ↓
┌─────────┐ ┌───────┐ ┌────────┐ ┌────────┐ ┌──────────────┐
│模型层   │ │RAG    │ │规则    │ │风险    │ │MCP服务管理   │
│OpenAI   │ │检索器 │ │引擎    │ │评估器  │ │+ 工具路由    │
│Adapter  │ │       │ │        │ │        │ │              │
└────┬────┘ └───┬───┘ └───┬────┘ └───┬────┘ └──────┬───────┘
     │          │         │          │             │
     ↓          ↓         ↓          ↓             ↓
┌─────────────────────────────────────────────────────────────┐
│                        数据层                                │
│  ┌──────────────────┐        ┌──────────────────────────┐  │
│  │   PostgreSQL     │        │    Faiss向量数据库        │  │
│  │  - 完整历史记录  │        │    - 问题向量检索        │  │
│  │  - 服务注册信息  │        │    - 相似案例匹配        │  │
│  │  - 用户偏好设置  │        │                          │  │
│  └──────────────────┘        └──────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 数据库层 (database/)

**PostgreSQL (postgresql.py)**
- 存储完整的工具调用历史
- 服务注册信息和状态
- 用户偏好和设置
- 工具调用指标

**Faiss向量数据库 (faiss_db.py)**
- 存储用户问题的向量embedding
- 快速相似度检索
- 支持自定义存储路径
- 支持多种索引类型（Flat, IVFFlat, HNSW）

**数据模型 (models.py)**
- `ToolCallHistory`: 工具调用历史
- `MCPService`: MCP服务注册表
- `ToolCallMetrics`: 工具调用指标
- `UserPreference`: 用户偏好设置

### 2. 模型层 (models/)

**基类 (base_model.py)**
- 定义模型适配器的抽象接口
- 所有模型必须实现：
  - `generate()`: 生成响应
  - `generate_stream()`: 流式生成
  - `get_embedding()`: 获取向量嵌入

**OpenAI适配器 (openai_adapter.py)**
- 支持所有OpenAI兼容格式的API
- 可用于：
  - OpenAI
  - Ollama
  - LM Studio
  - vLLM
  - 其他兼容服务

### 3. 核心逻辑层 (core/)

**RAG检索器 (rag_retriever.py)**
- 检索历史相似案例
- 分析历史反馈模式
- 提供用户偏好洞察

**风险评估器 (risk_assessor.py)**
- 基础风险（工具名称）
- 参数风险（敏感参数）
- 历史风险（过往记录）
- 规则风险（规则匹配）
- 综合评分和阈值判断

**规则引擎 (rule_engine.py)**
- 黑名单检查
- 自定义规则匹配
- 支持正则表达式
- 热更新规则

**主流程编排器 (orchestrator.py)**
- 整合所有组件
- 实现完整的处理流程
- 动态prompt注入
- 历史记录管理

### 4. MCP服务管理 (mcp_manager/)

**服务管理器 (service_manager.py)**
- 服务注册和生命周期管理
- 健康检查（后台任务）
- 熔断机制
- 性能指标统计

**工具路由器 (tool_router.py)**
- 意图检测
- 分层工具管理（L1/L2/L3）
- 按需加载工具
- 用户偏好工具

### 5. API层 (api/)

**路由 (routes.py)**
- RESTful API接口
- 请求/响应模型定义
- 依赖注入
- 错误处理

## 数据流

### 查询处理流程

```
用户查询
    ↓
1. 工具路由
    - 检测用户意图（天气、邮件、文件等）
    - 加载L1核心工具（始终加载）
    - 按需加载L2领域工具
    - 考虑用户偏好工具
    ↓
2. 模型生成
    - 发送消息和工具列表给模型
    - 模型返回工具调用草案
    ↓
3. RAG检索
    - 生成问题embedding
    - 在Faiss中搜索相似向量
    - 从PostgreSQL获取完整历史
    - 分析历史反馈
    ↓
4. 规则检查
    - 检查黑名单
    - 匹配自定义规则
    - 判断是否阻止
    ↓
5. 风险评估
    - 计算基础风险
    - 计算参数风险
    - 计算历史风险
    - 计算规则风险
    - 综合评分
    ↓
6. 决策
    - 风险分数 >= 阈值 → 需要确认
    - 规则强制确认 → 需要确认
    - 黑名单命中 → 阻止
    ↓
7. 生成响应
    - 动态prompt注入
    - 添加历史洞察
    - 添加风险原因说明
    ↓
8. 存储记录
    - 存入PostgreSQL
    - 生成并存储embedding到Faiss
    ↓
返回给用户
```

### 确认流程

```
用户确认
    ↓
更新数据库记录
    - user_confirmed
    - user_feedback
    - confirmed_at
    ↓
返回执行指令
    ↓
（外部）执行工具
    ↓
记录执行结果
    - execution_success
    - execution_result
    - executed_at
    ↓
用于强化学习
```

## 分层工具架构

### L1层：核心工具
- 特点：高频使用，低风险
- 加载策略：始终加载
- 示例：搜索、计算、时间查询

### L2层：领域工具
- 特点：按领域分类，中等风险
- 加载策略：按需激活
- 示例：天气服务、邮件服务、数据库查询

### L3层：高风险工具
- 特点：危险操作，需要授权
- 加载策略：显式授权后加载
- 示例：文件删除、支付、系统命令执行

## 监控与熔断

### 健康检查
- 定期检查所有活跃服务（默认30秒）
- 更新服务健康状态
- 记录最后检查时间

### 熔断机制
- **关闭状态 (closed)**: 正常工作
- **打开状态 (open)**: 连续失败达到阈值，停止调用
- **半开状态 (half_open)**: 超时后尝试恢复

### 指标监控
- 总调用次数
- 成功/失败次数
- 成功率
- 平均延迟

## 扩展性设计

### 1. 模型扩展
- 实现 `BaseModel` 接口
- 支持任意模型后端

### 2. 规则扩展
- JSON配置文件
- 支持正则表达式
- 可热更新

### 3. 工具扩展
- 注册API动态添加服务
- 支持多种工具格式

### 4. 存储扩展
- 数据库接口抽象
- 可替换其他存储方案

## 安全考虑

1. **黑名单机制**: 阻止危险操作
2. **规则引擎**: 灵活的安全策略
3. **风险评估**: 多维度评分
4. **用户确认**: 人工审核关键操作
5. **历史学习**: 从过往经验中学习
6. **熔断保护**: 防止雪崩效应

## 性能优化

1. **按需加载**: 不一次性加载所有工具
2. **向量检索**: Faiss快速相似度搜索
3. **数据库连接池**: 复用数据库连接
4. **异步处理**: 全异步架构
5. **并发健康检查**: 同时检查多个服务
